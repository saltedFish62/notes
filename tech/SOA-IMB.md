[TOC]

# SOA Service-Oriented Architecture

​	注意以下内容：

- SOA的价值
- SOA崛起的主要推动因素
- 基本SOA概念
- SOA的实现
- SOA管理
- 采用和实现SOA的准备工作以及预期效果

## SOA简介

### SOA 是什么：

​	一种体系架构方法，用于定义、链接和集成具有**清晰边界**且功能方面**自包含**的**可重用业务服务**。在这种类型的体系架构中，您可以对业务流程中的业务服务进行协调。通过采用服务的概念（一个独立于应用程序或基础设施 IT 平台以及上下文和其他服务的较高级别的抽象），SOA 将 IT 提升到了一个新的级别，更为适合互操作性和异类环境。

​	SOA构建于广泛采用的标准之上，所以可以快速构建服务和进行互连。

### SOA带来什么：

​	通过建立 SOA，可以将内部 IT 基础设施提高到一个更高、可见性更好且可管理的级别。通过可重用服务和高级流程，能以比以往任何时候都方便的方式进行更改，而且更像是分解部件（服务）并将其重新组合为新的与业务一致的流程。这不仅提高了效率和重用，而且还提供了极强的更改和保持 IT 与业务一致的能力。

### SOA最适合什么：

Questions：

> - SOA最适合那些业务功能和情况，以及那种情况最能体现其潜能？
> - 哪些情况和业务功能会由于SOA提高了竞争力和效率，而应该立即使用SOA？

Answer：

> - **多个实体使用的集中业务功能：** SOA 可帮助标识此类功能，并将其打包为可重用的自包含服务，不会受到相关流程更改的影响。
> - **与合作伙伴集成：** SOA 可推动标准的使用，而这在任何集成中都至关重要，因为标准为所有各方创建了共有的工作基准。另外，SOA 能提供出色的敏捷性，能够通过 SOA 的分离功能以对客户几乎无缝的方式灵活地插入、更改或更新服务，从而能增强集成体验。
> - **存在仍然在使用的旧技术：** 有些组织可能不愿意放弃行之有效的技术。安全顾虑让有些客户（特别是银行之类敏感行业）对新软件系统及其未知漏洞持怀疑态度。在这种情况下，SOA 可以帮助使用标准方式打包遗留技术，以便在适合进行集成和重用的基于标准的环境中使用。

### 什么因素促成了SOA最受欢迎的业务敏捷性支持

​	因为更改不可避免，业务连续性的为以保证就是预计更改并加以适应，亦称 **业务敏捷性**。SOA通过以下方面使业务敏捷性成为可能：

**松散耦合**

- 支持实时业务功能，因为其中消除了阻碍变更能力的硬连接
- 改变 IT 成本分布方式，在实现上面更为廉价，更多的投资可进行重用
- 提高对信息源的实时远程访问的可行性，从而减少延迟和依赖关系
- 集成项目是由业务需求驱动，并具有所提供功能的可见性（即业务是主要驱动因素）
- 通过公开和共享信息让公司获得更高的实时数据测定性能
- 缩短上市时间（因为可以加快到客户和合作伙伴的连接时间）
- 合作伙伴可以更快地与您的公司开展业务
- 推广和公开您的服务，更便于客户查找您和您的服务
- 通过搜索最适合您的需求的服务，更便于查找新的合作伙伴和服务

**重用**

- 提高流程一致性（因为依赖于相同的重用组件）
- 通过服务提供者间的竞争促进质量的提高
- 为客户提供广泛的提供商选择
- 几乎涵盖所有 IT 资产类：硬件、软件、数据和流程资产
- 减少更改的影响（因为更改在集中位置进行，然后就会在所涉及的所有各方上反映出来）
- 让您专注于业务流程，而不用太多考虑技术实现
- 帮助减少集成的成本（因为组件已经进行了集成）
- 让您在不约束业务更改的前提下进行系统更改
- 提升灵活性，从而获得更多的创新空间
- 允许一次发布多次使用

**可扩展性**

- 让各种规模的组织都能使用 SOA 解决方案
- 更改软件部署活动到更为动态且更为省时的模型，与业务更为相配
- 更便于添加或更改合作伙伴
- 加速合并和收购
- 方便公开服务，而这就代表着新的收益来源

## SOA概念

### SOA中的服务是什么

> “服务是定义良好、自包含且不依赖于上下文或其他服务的状态的功能。”
>
> “...服务定义为代表某个计算实体（如人工用户或其他程序）执行的工作单元。”

### SOA中松散耦合是什么

​	**先来了解一下什么是常规的松散耦合：**

- 如果改一个实体的同时，其他某些方面必须对应的修改，则实体是**耦合**的（例如，业务数据模型）。
- 如果实体的行为在服务接口中指定，且服务请求者和提供者只能在具有匹配的声明行为时才能进行交互，则该实体是**声明**的。声明的方面包括安全性、事务行为和服务质量（如响应时间和交付等）。
- 如果实体由服务请求者和服务提供者同时声明，但基础设施提供了一些转换功能来支持声明的行为不匹配的服务请求者和提供者间的交互，则该实体是**转换**的。
- 如果请求者和提供者都声明了自己能够支持的一系列行为，而对于每个交互，中间层基础设施都能够在二者之间协商一个一致同意的行为，则该实体是**协商**的。
- 如果交互中一方对特定方面的更改不需要其他方进行对应的更改，则该实体是**分解**的。

​    **松散耦合在SOA范式中的作用如下：**

- 它帮助在服务提供者和服务使用者之间形成一个抽象层。
- 松散耦合可提高在不影响服务使用者的情况下更改服务实现的灵活性。
- 在 SOA 方法中，功能组织为一系列模块化、可重用的共享服务。这些服务具有定义良好的接口，其中封装了用于访问服务的关键规则。这些服务还是在不假设谁将使用服务的情况下构建的。因此，能够与这些服务的使用者松散耦合。

### XML在SOA中作出了什么贡献？

​	SOA基于开放标准，能够促进独立于平台的业务集成，但需要一个公共平台作为基础设施的基础。这个基础设施需要各方都支持，以在认识方面达成一致。以下原因使XML成为该基础设施的核心:

- XML 是几乎所有 Web 服务标准的基础，如 XML 模式、SOAP、Web 服务描述语言（Web Services Description Language，WSDL）及统一描述、发现和集成（Universal Description, Discovery, and Integration，UDDI）等。这些标准利用了基于 XML 的表示形式的核心概念，此表示形式是受到全球广泛支持的格式，能用于在 SOA 中的服务提供者和请求者之间进行信息交换。
- 通过使用 XML 解决了跨不同平台使用不同应用程序中不同数据格式的问题。
- XML 本质上具有简化表示形式、基于文本、灵活且可扩展的好处。

**SOA使用的构建于XML之上的标准包括：**

- **SOAP(Service-Oriented Architecture Protocol):**

  这是基于 XML 的简单协议，允许应用程序通过 HTTP 等传输协议交换信息。在 SOAP 中使用 XML 保证了 SOAP 协议以下方面的特征：

  - 独立于平台。
  - 可在 Internet 上使用。
  - 能人工读取，具有结构化特征，且基于文本。

  由于具有上述好处，SOAP 是推荐使用的 Web 服务通信协议，使用最为广泛。由于 Web 服务是 SOA 的基础，因此这个协议也是 SOA 解决方案的基本通信协议。

- **WSDL(Web Services Description Language):**

  WSDL 是以 XML 格式编写的用于描述 Web 服务的文档。它指定服务的位置和服务向访问此服务的个体公开的操作（或方法）。WSDL 文件描述四个主要事项：

  - Web 服务接口提供的服务，如方法的列表名称和属性消息。
  - 消息的数据类型
  - 传输协议（如 HTTP 和 JMS）的绑定信息
  - 调用时使用的服务地址

- **使用可扩展标记语言的电子商务（Electronic Business using eXtensible Markup Language，ebXML）：**

  ebXML 是定义企业间执行的业务事务的标准方式。ebXML 定义了业务消息交换的标准方法，建立了公司间的贸易通信和注册业务流程。

### 服务注册中心

> 服务注册中心是 SOA 系统中可用的服务的目录。其中包含服务的物理位置、版本及服务有效期、服务文档和策略。服务注册中心是 SOA 体系架构的主要构建块之一。

- 服务注册中心实现 SOA 的松散耦合承诺。通过保存服务端点位置，消除了在使用者和提供者之间进行硬编码所带来的高度耦合。另外还消除了在需要的情况下替换服务实现的潜在难题。
- 服务注册中心具有很高的可伸缩性，可以在系统服务逐步发展的情况下无缝地提升。
- 它允许系统分析人员对企业的业务服务投资组合进行调查。他们可以随后确定哪些服务可用于实现流程自动化来应对迫切的业务需求，哪些服务不能用于此目的，从而让您知道需要在投资组合中实现和添加什么，并会提供可用服务目录。
- 服务注册中心可以通过强制遵从订阅服务来逐步过渡到治理服务的角色。这可帮助确保服务治理和策略的完整性。在本教程稍后，您将了解关于治理及其在 SOA 中的重要性。
- 可用服务及其接口的可见性可加快开发速度、提高应用程序重用、改善治理和改进业务规划及管理。没有服务注册中心会导致冗余和效率低下。
- 服务注册中心可帮助减少在定位服务信息方面浪费的时间。
- 如果不使用注册中心来跟踪服务及其关系，SOA 环境不仅会缺少一致性和控制，还会出现混乱。

### 业务流程

> “业务流程可以定义为链接到跨功能边界的活动的一组相互关联的任务。业务流程具有起点和终点，是可重复的。”
>
> 业务流程可以视为业务实体为了响应事件而执行的一组活动。这一组活动在业务流程中彼此协调，一起描述并集成到一起。

​	为个人发放身份证就是一个业务流程。您提供您的出生证明、教育和专业证书及一张照片来启动流程。然后将创建内部文件，对您进行安全调查，最后，完成了所有处理后，就拿到了身份证了。

​	在 SOA 范式中，业务流程对服务流进行控制。业务流程驱动事件流，调用和协调服务，并为其创建上下文来进行相互通信。业务流程代表业务抽象，同服务实现进行了分离，是关于业务流的流程。通过这个关注分离，不仅可以将更多精力放在流程创建上，而且还可以更方便地根据需要编辑流程，但不用对基础服务实现进行编辑。

**业务流程的组成元素**

- **输入：**流程的活动为了产生结果所需的信息。在身份证示例中，输入应该为您的凭据、出生证明和照片。
- **输出：**流程生成的所有数据和信息。输出代表业务目标和业务所需的度量数据。在身份证示例中，输出是您的内部文件和实际身份证以及关于流程如何进行的度量数据。
- **事件：**一些重要情况的通知。例如，某个指示信息。事件可能在流程的执行前、执行中和执行后发生。在身份证示例中，可能会出现关于最开始没有提供需要包括的新文档的事件。
- **子流程：**流程中较小的流程或流程步骤。使用一组活动不足以表示工作范围时，将使用子流程。子流程具有与流程相同的组成元素。在身份证示例中，这可以为调查犯罪记录并获得结果的子流程。
- **活动：**流程中级别最低的工作单位。在身份证示例中，为申办身份证的人创建新内部文件的工作就是一个活动。
- **性能度量：**表示流程有效性的属性，用于确定是否满足所需的性能。这些度量可以帮助确定性能并将其与所需的指标进行比较。通过这些性能度量还能确定流程改进的潜在区域，最终（理想的情况下）实现 SOA 承诺的改进周期。在身份证示例中，度量数据中将计算流程的哪个部分使用的时间最多或处理命中率最高。这可以在以后帮助改进流程。

### SOA如何处理事务控制

​	因为流程跨多个活动，因此 SOA 环境中出现的业务事务可能会非常复杂。这是由于 SOA 上下文中长时间运行的流程中的服务的本质所决定的，此类服务通常具有异步、无状态、分布式和不透明的特点。

​	Web 服务是 SOA 环境中最完美的服务表示形式。Web 服务具有 SOA 所需的自包含特性，但在涉及跨服务事务需求时就有些局限了。只要服务位于事务的根部，且事务的范围受到服务的基础解决方案逻辑所执行的活动的限制，就不需要跨服务事务功能，而且事务可以通过封装的任何专有技术（基于组件的技术、遗留技术或其他技术）进行管理。但随着环境中服务数量的增加，对跨这些服务的事务的需求就会增加。

​	一些 Web 服务（WS）规范被用来处理事务的问题。这包括：

- **WS-Coordination：**允许注册流程参与活动，以创建共享上下文，负责保存流程间传播的有状态数据和信息以及事务状态。此框架允许现有事务处理、工作流和其他要协调的系统隐藏其专用协议，从而在异类环境中协同工作。此协议为使用其框架的其他协议（如 WS-AtomicTransaction 或 WS-BusinessActivity）提供基础设施。

- **WS-AtomicTransaction：**

  用于短期存在的分布式活动。它提供了可与 WS-Coordination 框架结合使用的三种类型的协议，供两阶段提交 ACID 类型（支持原子性、一致性、隔离性和持久性的事务）选择使用：

  - 完成
  - 易失两阶段提交
  - 持久两阶段提交

- **WS-BusinessActivity：**

  此协议用于长时间运行的带有补偿流程的事务。对于 WS-AtomicTransaction 协议，它使用 WS-Coordination 框架提供用于业务活动协调的两个协议：

  - BusinessAgreementWithParticipantCompletion
  - BusinessAgreementWithCoordinatorCompletion

## 基本SOA体系架构

### 基本SOA体系架构由哪些部分组成

​	基本SOA体系架构包括服务提供者、服务和可选的服务目录。 应用程序到应用程序的消息传递在信息交换中使用。

​	这个模型和简单 Web 服务之间的相似性非常明显，二者都将 WSDL 作为存储在服务目录中的调用契约（可以通过 UDDI 在其中进行查询和获取）。Web 服务实际上是最基本的 SOA 实现。

​	在这样的模型中，基本场景如下：

> 首先，服务提供者创建服务，并决定将其公开并发布。发布是通过将服务信息发布到服务目录上来完成的。另一方面，需要特定服务的服务请求者将在服务目录中搜索满足必要条件的服务。找到服务后，通过使用服务目录中的可用信息，服务请求者能够以正确的方式直接联系服务提供者，从而满足业务需求。

![基本SOA体系架构](http://ww4.sinaimg.cn/large/006tNc79gy1g5kbc9mexmg309a054mx1.gif)

- **服务提供者 Service provider：**发布了调用契约和位置的服务的提供者
- **服务使用者 Service consumer：**服务目录中找到的与其业务需求匹配的服务的使用者
- **服务目录 Service directory：**用于发布服务和为使用者列出可用服务的目录。

### ESB 在 SOA 中扮演什么角色？

> 企业服务总线（Enterprise Service Bus，ESB）

​	从基础的角度而言，它代表着能够连接服务提供者和服务使用者的中枢和基础架构。

- 提供与 SOA 原则一致的集成基础设施：
  - 强制使用独立于实现的显式接口来定义采用松散耦合的服务
  - 使用强调位置透明性和互操作性的通信协议
  - 促进采用封装可重用业务功能的方式定义服务
- 提供管理服务基础设施的方法
- 在分布式异类环境中操作，因为它：
  - 支持同步和异步通信
  - 使用标准接口和标准协议
- 集中控制和分散处理
- 支持中介，根据需要在不同各方之间形成请求/响应，而且不用更改其中任何一方
- 将安全性和 QoS 应用到 SOA 项目

### 什么是编排？它如何适应 SOA 大方略？

> 业务服务编排考虑的是业务流逻辑的开发和执行，与基础服务和业务逻辑相独立。这意味着，流程编排考虑的是事件的顺序，以及事件如何相关，但并不关心事件本身。流程和服务之间的关注分离提供了足够的灵活性，能够方便地更改流程，而不会对核心服务造成影响。这一点遵循了 SOA 的松散耦合目标。

BPEL4WS 建立于 Web 服务标准之上。此类标准的兼容性让流程能够调用基于标准的开放基础设施中的基础服务和合作伙伴服务。使用 BPEL4WS 定义的流程包括：

- 活动，即流程内的各个业务步骤。活动可以为基本活动或由其他活动组成（结构化活动）。
- 合作伙伴链接，指定使用 WSDL 接口与流程交互的外部实体（或反向关系）。
- 存储活动间传递的消息的变量，因而代表状态。
- 相关集，用于将多个服务请求或响应消息与相同的业务流程实例相关。
- 错误处理程序，用于处理在业务流程运行时可能出现的异常情况。
- 事件处理程序，并行于普通执行进程接受和处理消息。
- 补偿处理程序，指定在出现异常时撤销一个或多个活动的补偿逻辑。

#### 业务流程类型

业务流程可以为**长时间运行的流**或**微流**：

- **长时间运行流程**是可中断的，也可以运行于多个事务中。此类流程可以等待外部诱因，例如使用人工任务导致的结果等。根据经验，如果流程包含人工任务，则流程一定为长时间运行的流程。长时间运行的流程还可以同时包含同步和异步服务。长时间运行的流程存储每个中间流程状态，以便获得前向可恢复性。
- **微流**在没有中断的单个线程中运行。此类流程也称为不可中断业务流程。微流仅在一个事务中运行，持续时间短，而且仅由同步服务组成。

### SOA 生命周期及其不同的阶段

​	SOA 具有动态生命周期的特点。动态生命周期即意味着可能持续地改进流程，而这一点通过与 SOA 所采用的松散耦合相结合，可以让流程像分解和重新组合构建块（这种情况下指服务）一样方便地进行流程改进，而不用完全返工。这可缩短上市时间和改善业务和 IT 的一致性。

​	著名的 SOA 生命周期关系图包括四个互连的六边形图（代表 SOA 的四个阶段）。如下图所示，这四个阶段形成了闭合环，代表了监视和改进的持续循环。

![SOA声明周期的四个阶段](http://ww3.sinaimg.cn/large/006tNc79gy1g5kbvf5r8eg305u0420sl.gif)

**建模阶段（Model）：**

​	建模阶段包括业务分析和需求收集，然后是对业务流程进行建模和优化。模型可帮助对流程、其目标和输出达成一致的认识。它还能确保设计满足业务需求，并为以后测定性能提供基准。

**组装阶段（Assemble）：**

​	在此阶段，所建模的流程中需要的现有资产（如企业资源规划（Enterprise Resource Planning，ERP）、财务系统、IBM CICS® 应用程序等）将被包装为服务，并同时实现和测试需要但还不存在的功能。所有服务可用之后，则可以对其进行编排，以实现业务流程。

**部署阶段（Deploy）：**

​	在部署阶段，可以配置运行时环境来满足所需的服务质量级别和安全需求。可以对环境进行伸缩和优化，以便能可靠地运行任务关键型流程，而且同时还能提供在更改时进行动态更新的灵活性。

**管理阶段（Manage）：**

​	在此阶段，将管理和监视多个方面，如服务资产、服务可用性和响应时间以及对服务的版本控制。此阶段的一个重要角色是监视流程的关键性能指标（Key Performance Indicator，KPI）。这可帮助防止或隔离和诊断实时出现的问题，并能提供关于业务流程性能和瓶颈的反馈，以帮助进行改进。此反馈发送到建模阶段（第一步），用于帮助改进流程。

## SOA管理

​	正如第一部分所述，SOA 需要可靠的活动管理框架，否则就可能会失控。SOA 管理通过治理概念实现，治理控制着 SOA 的不同方面。因为 SOA 具有开放的特征，因此启用了 SOA 的环境中必须强制要求的另一个方面就是安全。此部分将对 SOA 管理进行详细讨论。

### SOA治理

​	如果没有控制实体，SOA 不仅会带来管理难题，而且还会由于开放和分布式特性带来混乱。因为这个原因，SOA 需要管理和控制实体：治理。

**治理的定义**

> SOA 治理是用于决策和角色标识的框架，用于鼓励与企业战略同步的 IT 操作，并防止那些与其相悖的操作。此框架由一个专门的团队或委员会管理，他们负责创建策略来执行治理和角色标识、授权和保证获得了决策与策略执行能力的人员的可靠性。

委员会要处理三个主要的问题：

- 为了确保有效的 IT 资产管理，需要进行哪些决策？
- 谁应该负责进行这些决策？
- 此类决策如何执行和监视？

​    作为治理实现的一部分，将标识和监视服务水平协议（Service Level Agreement，SLA），以进行验证。也会收集性能度量来表示治理的有效性。

### 治理在SOA环境中扮演什么角色

![相对于SOA生命周期阶段的治理位置](http://ww2.sinaimg.cn/large/006tNc79gy1g5kj6fugu1g306a052q2u.gif)

​	SOA生命周期的所有阶段都要启用治理。因为：

- 治理涉及到应用企业战略的原则来指导和控制 IT。
- 治理的目标是鼓励与用于实现企业业务目标的组织任务、战略和价值相一致的行为，以在求得风险和回报平衡的同时提高价值。
- 治理确保从完整性、性能、可靠性和资金角度将服务保持在所定义的水平。
- 治理确保正确地评估业务应用程序需求和确定其优先级，以推动服务的创建和使用，从而确保在保持与业务目标一致的情况下的最佳利用率。
- 治理确保以有利的方式使用 IT 投资。
- 治理确保将启用了 SOA 的企业级体系架构作为任何服务设计的主要指导思想。
- 作为控制实体，治理充分利用了 IT 原则的最佳实践。
- 为了保护业务资产，治理还会强制要求保证企业的数据安全性和跨边界共享的信息的私密性。
- 治理用于管理企业的 IT 资产，负责保证数据和流程的完整性和可靠性，以充分利用重用和实现利益最大化。
- 治理可确保使用者-提供者服务链上的所有组件保持一定级别的性能和服务质量。
- 标准是 SOA 的基础，因此治理可以帮助实现高级别的互操作性，充分利用开放标准所提供的所有好处。
- 治理使用度量标准来审核和监视 IT 基础设施开发的进度及其对已经建立的策略的遵从情况。

## 准备实现SOA

​	在组织中引入 SOA 的过程需要特殊的技能，包括：

- 能够确定组织对这样的调整的准备情况。
- 标识边界和入口点。
- 通过 SOA 能够为业务和 IT 带来的好处开导大家。
- 从业务和技术角度评估 SOA 引入方面的挑战和驱动因素。

### SOA 能为业务和 IT 战略提供什么好处？

**SOA 对业务的好处包括：**

- 提高业务对市场变化的响应能力，提高组织方面的敏捷性。
- 避开组织边界，加强与现有资产的协作。
- 帮助缩短开发时间。
- 发现业务流程中效率低下的情况。
- 确保 IT 资源与业务战略及目标保持一致。
- 通过执行标准减少遵从性和安全性成本。
- 合作伙伴和使用者能够更方便地找到您，您也可以更方便地找到他们。
- 保证更为一致的流程。
- 为提供者提供不同的选项（因为执行了标准）。
- 允许资产重用。
- 减少集成的成本。
- 简化升级和合并的相关工作。

**SOA 对 IT 战略的好处包括：**

- 恰当设计系统体系架构，从而有效地使用标准和服务，以获得其承诺的业务优势。
- 允许使用各种通信机制。
- 允许加入灵活且可靠的安全系统来确保安全性。
- 提供服务总线，可以在其中对消息流和消息本身进行管理，从而在系统的灵活性和适应性方面锦上添花。
- 通过模块化的组件型服务和服务总线简化集成工作。
- 构建于受到广泛支持的标准和协议之上，从而实现 SOA 从始至终的一个目标，即互操作性。
- 通过服务存储库和中介模块推动重用。
- 使用 ESB 推动连接性（ESB 将连接性发展带到了顶峰）。ESB 负责协议、数据和格式的中介，以确保兼容性。

